# 选课管理模块设计文档

## 概述
该模块核心是实现高一行政班到高二选科固定班的平稳过渡，满足分层选科、人数阈值校验、选课调整的业务流程。

## 基础规则定义

### 课程范围
- 高中共 9 门课程，高一全员必修 9 门
- 高二分 3 门主科（默认必修）+ 物理 / 历史二选一 + 政地生化四选二的组合选科模式

### 分班模式
- 以 "主科 + 物理 / 历史 + 政地生化两门" 的完整选科组合独立开班
- 非仅物理类、历史类大类分班

### 开班阈值
- 需预设每个选科组合的最低开班人数(40)，低于阈值时，该组合下学生需自主重新选择选科组合
- 已成功开班的选课组合自动创建班级并更新学生表，每个班级最多50人

## 班级数据管理

### 高一班级
- 存储行政班信息，作为学生初始归属班级
- 高二分班后需保留高一行政班历史记录

### 高二班级
- 存储选科组合对应的固定班级信息
- 建立与高一行政班的关联关系
- 记录班级对应的选科组合、开班状态、学生名单

## 选课流程管理

### 人数统计校验
- 实时统计各选科组合的报名人数，与开班阈值比对，生成人数不足的组合报表

## 存储过程设计

### 1. CheckSubjectCombinationThreshold 存储过程
**功能**: 统计各选科组合人数并检查开班阈值，自动为达到阈值的组合开班

**参数**:
- `min_class_size` - 最低开班人数阈值

**功能描述**:
- 按选科组合统计学生人数
- 为达到阈值的组合自动创建班级
- 更新学生和选课记录表中的班级分配
- 返回统计结果，包括已开班和人数不足的组合

### 2. AdjustStudentCourseSelection 存储过程
**功能**: 处理学生选课调整请求

**参数**:
- `p_student_id` - 学生ID
- `p_one_choose_one` - 物理/历史选择
- `p_four_choose_two` - 政地生化四选二选择

**功能描述**:
- 更新学生的选课记录
- 将学生从原班级中移除，暂时返回高一行政班
- 设置选课状态为"待确认"

### 3. HandleInsufficientCombination 存储过程
**功能**: 处理人数不足的选科组合，将相关学生状态设为"需调整"

**功能描述**:
- 检测低于开班阈值的选科组合
- 将这些组合中的学生选课状态设为"需调整"
- 返回需要重新选课的学生信息

### 4. GetSubjectCombinationCount 函数
**功能**: 获取特定选科组合的当前报名人数

**参数**:
- `p_one_choose_one` - 物理/历史选择
- `p_four_choose_two` - 政地生化四选二选择

**返回值**: 选科组合的报名人数

## 业务流程

### 开班流程
1. 学生完成选课志愿填报
2. 管理员调用 `CheckSubjectCombinationThreshold` 过程
3. 系统统计各选科组合人数
4. 为达到阈值的组合自动创建班级
5. 将学生分配到对应选科班
6. 返回开班统计结果

### 选课调整流程
1. 学生或管理员发起选课调整请求
2. 调用 `AdjustStudentCourseSelection` 过程
3. 系统更新选课记录，取消原班级分配
4. 学生状态设为"待确认"

### 人数不足处理流程
1. 管理员发现某些组合人数不足
2. 调用 `HandleInsufficientCombination` 过程
3. 系统将相关学生状态设为"需调整"
4. 返回需要重新选课的学生列表

## 数据一致性保证
- 使用事务处理选课调整过程，确保数据一致性
- 通过外键约束维护学生与班级、选课记录的关系
- 班级人数自动更新，保持与实际选课情况同步
